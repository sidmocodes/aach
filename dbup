import com.zaxxer.hikari.HikariDataSource;
import com.zaxxer.hikari.pool.HikariPoolMXBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;
import java.sql.Connection;

@Component
public class UpDbPool {

    @Autowired
    private DataSource dataSource; // HikariCP DataSource

    @Autowired
    private HikariConfigProperties hikariConfigProperties; // Injected Hikari properties

    /**
     * Resets the Hikari connection pool using values from HikariConfigProperties.
     */
    public String resetConnectionPool() {
        try {
            if (dataSource instanceof HikariDataSource) {
                HikariDataSource hikariDataSource = (HikariDataSource) dataSource;

                // Close the existing pool
                hikariDataSource.close();

                // Reinitialize the pool using HikariConfigProperties
                hikariDataSource.setMaximumPoolSize(hikariConfigProperties.getMaximumPoolSize());
                hikariDataSource.setMinimumIdle(hikariConfigProperties.getMinimumIdle());
                hikariDataSource.setIdleTimeout(hikariConfigProperties.getIdleTimeout());
                hikariDataSource.setMaxLifetime(hikariConfigProperties.getMaxLifetime());
                hikariDataSource.setLeakDetectionThreshold(hikariConfigProperties.getLeakDetectionThreshold());
                hikariDataSource.setConnectionTestQuery(hikariConfigProperties.getConnectionTestQuery());

                // Validate the reconfigured pool
                validate(hikariDataSource);

                return "Database pool has been reset and validated successfully.";
            } else {
                throw new IllegalStateException("Datasource is not HikariCP. Pool cannot be reset.");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
            return "Failed to reset and validate the database pool: " + ex.getMessage();
        }
    }

    /**
     * Validates the Hikari connection pool to ensure it is operational.
     *
     * @param hikariDataSource The HikariDataSource to validate.
     * @throws Exception If validation fails.
     */
    private void validate(HikariDataSource hikariDataSource) throws Exception {
        // Check connection validity
        try (Connection connection = hikariDataSource.getConnection()) {
            if (connection == null || connection.isClosed() || !connection.isValid(2)) {
                throw new Exception("HikariCP pool validation failed: connection is not valid.");
            }
        } catch (Exception ex) {
            throw new Exception("HikariCP pool validation failed during connection test: " + ex.getMessage(), ex);
        }

        // Check pool state via HikariPoolMXBean
        HikariPoolMXBean poolMXBean = hikariDataSource.getHikariPoolMXBean();
        if (poolMXBean == null) {
            throw new Exception("HikariCP pool validation failed: HikariPoolMXBean is null.");
        }
        if (poolMXBean.getTotalConnections() == 0) {
            throw new Exception("HikariCP pool validation failed: no total connections in the pool.");
        }

        System.out.println("HikariCP pool validation successful. Active connections: " + poolMXBean.getActiveConnections()
                + ", Idle connections: " + poolMXBean.getIdleConnections());
    }
}
