<build>
  <plugins>

    <!-- STEP 1: Shade Scala/Spark's Jackson 2.13.5 -->
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-shade-plugin</artifactId>
      <version>3.5.1</version>

      <executions>
        <execution>
          <id>shade-jackson</id>
          <phase>package</phase>
          <goals>
            <goal>shade</goal>
          </goals>

          <configuration>
            <!-- attach separate shaded artifact -->
            <shadedArtifactAttached>true</shadedArtifactAttached>
            <shadedClassifierName>shaded</shadedClassifierName>

            <!-- DO NOT reduce pom for spring boot -->
            <createDependencyReducedPom>false</createDependencyReducedPom>

            <!-- relocate ONLY jackson 2.13.5 -->
            <relocations>
              <relocation>
                <pattern>com.fasterxml.jackson</pattern>
                <shadedPattern>shaded.jackson213</shadedPattern>
                <includes>
                  <include>com.fasterxml.jackson.core:jackson-core</include>
                  <include>com.fasterxml.jackson.core:jackson-databind</include>
                </includes>
              </relocation>
            </relocations>

            <!-- include META-INF/services merging -->
            <transformers>
              <transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/>
              <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"/>
            </transformers>
          </configuration>
        </execution>
      </executions>
    </plugin>

    <!-- STEP 2: Repackage the SHADED jar using Spring Boot -->
    <plugin>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-maven-plugin</artifactId>

      <executions>
        <execution>
          <id>repackage-shaded</id>
          <goals>
            <goal>repackage</goal>
          </goals>

          <!-- VERY IMPORTANT: tell Spring Boot to use the shaded classifier -->
          <configuration>
            <classifier>shaded</classifier>
          </configuration>
        </execution>
      </executions>
    </plugin>

  </plugins>
</build>
